{"version":3,"sources":["../../../../../src/Apps/Auction/Routes/ConfirmBid/index.tsx"],"names":["logger","MAX_POLL_ATTEMPTS","ConfirmBidRoute","props","pollCount","artwork","me","relay","saleArtwork","sale","environment","trackEvent","createBidderPosition","maxBidAmountCents","Promise","resolve","reject","onCompleted","data","onError","error","mutation","variables","input","sale_id","id","artwork_id","max_bid_amount_cents","onJsError","actions","bidderId","trackConfirmBidFailed","message","setSubmitting","setStatus","errors","action_type","Schema","ActionType","ConfirmBidFailed","bidder_id","error_messages","trackConfirmBidSuccess","positionId","selectedBidAmountCents","ConfirmBidSubmitted","bidder_position_id","order_id","products","product_id","_id","quantity","price","handleSubmit","values","selectedBid","Number","possibleExistingBidderId","registrationStatus","then","verifyBidderPosition","catch","result","position","messageHeader","sale_artwork","status","bidderPositionID","res","checkBidderPosition","bidderPosition","setTimeout","window","location","assign","sd","APP_URL","getInitialSelectedBid","qs","querystring","parse","search","slice","bid","undefined","TrackingWrappedConfirmBidRoute","Component","p","context_page","PageName","AuctionConfirmBidPage","auction_slug","artwork_slug","user_id","ConfirmBidRouteFragmentContainer"],"mappings":"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","sourcesContent":["import { Box, Separator, Serif } from \"@artsy/palette\"\nimport { BidderPositionQueryResponse } from \"__generated__/BidderPositionQuery.graphql\"\nimport {\n  ConfirmBidCreateBidderPositionMutation,\n  ConfirmBidCreateBidderPositionMutationResponse,\n} from \"__generated__/ConfirmBidCreateBidderPositionMutation.graphql\"\nimport { routes_ConfirmBidQueryResponse } from \"__generated__/routes_ConfirmBidQuery.graphql\"\nimport {\n  BidFormFragmentContainer as BidForm,\n  FormValues,\n} from \"Apps/Auction/Components/BidForm\"\nimport { LotInfoFragmentContainer as LotInfo } from \"Apps/Auction/Components/LotInfo\"\nimport { bidderPositionQuery } from \"Apps/Auction/Routes/ConfirmBid/BidderPositionQuery\"\nimport { AppContainer } from \"Apps/Components/AppContainer\"\nimport { trackPageViewWrapper } from \"Apps/Order/Utils/trackPageViewWrapper\"\nimport { track } from \"Artsy\"\nimport * as Schema from \"Artsy/Analytics/Schema\"\nimport { useTracking } from \"Artsy/Analytics/useTracking\"\nimport { FormikActions } from \"formik\"\nimport qs from \"qs\"\nimport React from \"react\"\nimport { Title } from \"react-head\"\nimport {\n  commitMutation,\n  createFragmentContainer,\n  graphql,\n  RelayProp,\n} from \"react-relay\"\nimport { data as sd } from \"sharify\"\nimport { get } from \"Utils/get\"\nimport createLogger from \"Utils/logger\"\n\nconst logger = createLogger(\"Apps/Auction/Routes/ConfirmBid\")\n\ntype BidFormActions = FormikActions<FormValues>\n\ninterface ConfirmBidProps {\n  artwork: routes_ConfirmBidQueryResponse[\"artwork\"]\n  me: routes_ConfirmBidQueryResponse[\"me\"]\n  relay: RelayProp\n  location: Location\n}\n\nconst MAX_POLL_ATTEMPTS = 20\n\nexport const ConfirmBidRoute: React.FC<ConfirmBidProps> = props => {\n  let pollCount = 0\n\n  const { artwork, me, relay } = props\n  const { saleArtwork } = artwork\n  const { sale } = saleArtwork\n  const { environment } = relay\n  const { trackEvent } = useTracking()\n\n  function createBidderPosition(maxBidAmountCents: number) {\n    return new Promise<ConfirmBidCreateBidderPositionMutationResponse>(\n      (resolve, reject) => {\n        commitMutation<ConfirmBidCreateBidderPositionMutation>(environment, {\n          onCompleted: data => resolve(data),\n          onError: error => reject(error),\n          mutation: graphql`\n            mutation ConfirmBidCreateBidderPositionMutation(\n              $input: BidderPositionInput!\n            ) {\n              createBidderPosition(input: $input) {\n                result {\n                  position {\n                    id\n                    sale_artwork {\n                      sale {\n                        registrationStatus {\n                          id\n                        }\n                      }\n                    }\n                  }\n                  status\n                  messageHeader: message_header\n                }\n              }\n            }\n          `,\n          variables: {\n            input: {\n              sale_id: sale.id,\n              artwork_id: artwork.id,\n              max_bid_amount_cents: maxBidAmountCents,\n            },\n          },\n        })\n      }\n    )\n  }\n\n  function onJsError(actions: BidFormActions, error: Error, bidderId: string) {\n    logger.error(error)\n    trackConfirmBidFailed(bidderId, [`JavaScript error: ${error.message}`])\n    actions.setSubmitting(false)\n    actions.setStatus(\n      \"Something went wrong while processing your bid. Please make sure your internet connection is active and try again\"\n    )\n  }\n\n  function trackConfirmBidFailed(bidderId: string, errors: string[]) {\n    trackEvent({\n      action_type: Schema.ActionType.ConfirmBidFailed,\n      bidder_id: bidderId,\n      error_messages: errors,\n    })\n  }\n\n  function trackConfirmBidSuccess(\n    positionId: string,\n    bidderId: string,\n    selectedBidAmountCents: number\n  ) {\n    trackEvent({\n      action_type: Schema.ActionType.ConfirmBidSubmitted,\n      bidder_position_id: positionId,\n      bidder_id: bidderId,\n      order_id: bidderId,\n      products: [\n        {\n          product_id: artwork._id,\n          quantity: 1,\n          price: selectedBidAmountCents / 100,\n        },\n      ],\n    })\n  }\n\n  function handleSubmit(values: FormValues, actions: BidFormActions) {\n    const selectedBid = Number(values.selectedBid)\n    const possibleExistingBidderId: string | null =\n      sale.registrationStatus && sale.registrationStatus.id\n\n    createBidderPosition(selectedBid)\n      .then(data =>\n        verifyBidderPosition({\n          actions,\n          data,\n          selectedBid,\n          possibleExistingBidderId,\n        })\n      )\n      .catch(error => onJsError(actions, error, possibleExistingBidderId))\n  }\n\n  function verifyBidderPosition({\n    actions,\n    data,\n    possibleExistingBidderId,\n    selectedBid,\n  }: {\n    actions: BidFormActions\n    data: ConfirmBidCreateBidderPositionMutationResponse\n    possibleExistingBidderId: string\n    selectedBid: number\n  }) {\n    const { result } = data.createBidderPosition\n    const { position, messageHeader } = result\n    const bidderId =\n      possibleExistingBidderId ||\n      (position &&\n        position.sale_artwork &&\n        position.sale_artwork.sale &&\n        position.sale_artwork.sale.registrationStatus.id)\n\n    if (result.status === \"SUCCESS\") {\n      bidderPositionQuery(environment, { bidderPositionID: position.id })\n        .then(res =>\n          checkBidderPosition({ actions, data: res, bidderId, selectedBid })\n        )\n        .catch(error => onJsError(actions, error, bidderId))\n    } else {\n      actions.setStatus(messageHeader)\n      actions.setSubmitting(false)\n      trackConfirmBidFailed(bidderId, [messageHeader])\n    }\n  }\n\n  function checkBidderPosition({\n    actions,\n    data,\n    bidderId,\n    selectedBid,\n  }: {\n    actions: BidFormActions\n    data: BidderPositionQueryResponse\n    bidderId: string\n    selectedBid: number\n  }) {\n    const { bidderPosition } = data.me\n    const { status, position, messageHeader } = bidderPosition\n\n    if (status === \"PENDING\" && pollCount < MAX_POLL_ATTEMPTS) {\n      // initiating new request here (vs setInterval) to make sure we wait for\n      // the previous call to return before making a new one\n      setTimeout(\n        () =>\n          bidderPositionQuery(environment, { bidderPositionID: position.id })\n            .then(res =>\n              checkBidderPosition({ actions, data: res, bidderId, selectedBid })\n            )\n            .catch(error => onJsError(actions, error, bidderId)),\n        1000\n      )\n\n      pollCount += 1\n    } else if (status === \"WINNING\") {\n      trackConfirmBidSuccess(position.id, bidderId, selectedBid)\n      window.location.assign(`${sd.APP_URL}/artwork/${artwork.id}`)\n    } else {\n      actions.setStatus(messageHeader)\n      actions.setSubmitting(false)\n      trackConfirmBidFailed(bidderId, [messageHeader])\n    }\n  }\n\n  return (\n    <AppContainer>\n      <Title>Confirm Bid | Artsy</Title>\n\n      <Box maxWidth={550} px={[2, 0]} mx=\"auto\" mt={[1, 0]} mb={[1, 100]}>\n        <Serif size=\"8\">Confirm your bid</Serif>\n\n        <Separator />\n\n        <LotInfo artwork={artwork} saleArtwork={artwork.saleArtwork} />\n\n        <Separator />\n\n        <BidForm\n          initialSelectedBid={getInitialSelectedBid(props.location)}\n          showPricingTransparency={false}\n          saleArtwork={saleArtwork}\n          onSubmit={handleSubmit}\n          me={me}\n        />\n      </Box>\n    </AppContainer>\n  )\n}\n\nconst getInitialSelectedBid = (location: Location): string | undefined => {\n  return get(\n    qs,\n    querystring => querystring.parse(location.search.slice(1)).bid,\n    undefined\n  )\n}\n\nconst TrackingWrappedConfirmBidRoute: React.FC<ConfirmBidProps> = props => {\n  const Component = track<ConfirmBidProps>(p => ({\n    context_page: Schema.PageName.AuctionConfirmBidPage,\n    auction_slug: p.artwork.saleArtwork.sale.id,\n    artwork_slug: p.artwork.id,\n    sale_id: p.artwork.saleArtwork.sale._id,\n    user_id: p.me.id,\n  }))(ConfirmBidRoute)\n\n  return <Component {...props} />\n}\n\nexport const ConfirmBidRouteFragmentContainer = createFragmentContainer(\n  trackPageViewWrapper(TrackingWrappedConfirmBidRoute),\n  {}\n)\n"],"file":"index.js"}