{"version":3,"sources":["../../../../../src/Apps/Order/Routes/Accept/index.tsx"],"names":["logger","Accept","acceptOffer","orderOrError","commerceBuyerAcceptOffer","error","handleAcceptError","props","router","push","order","id","dialog","showErrorDialog","commitMutation","variables","input","offerId","lastOffer","mutation","code","parsedData","e","JSON","parse","data","decline_code","showCardFailureDialog","title","message","routeToArtistPage","showConfirmDialog","cancelButtonText","confirmButtonText","confirmed","o","lineItems","edges","node","artwork","artists","artistId","route","onTransition","window","location","assign","isCommittingMutation","counterofferFlowSteps","pointerEvents","createdAt","stateExpiresAt","onChangeResponse","onSubmit","className","Component","AcceptFragmentContainer"],"mappings":"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","sourcesContent":["import { Button, Col, Flex, Row, Spacer } from \"@artsy/palette\"\nimport { Accept_order } from \"__generated__/Accept_order.graphql\"\nimport { HorizontalPadding } from \"Apps/Components/HorizontalPadding\"\nimport { TwoColumnLayout } from \"Apps/Order/Components/TwoColumnLayout\"\nimport { track } from \"Artsy/Analytics\"\nimport { RouteConfig, Router } from \"found\"\nimport React, { Component } from \"react\"\nimport { Media } from \"Utils/Responsive\"\nimport {\n  counterofferFlowSteps,\n  OrderStepper,\n} from \"../../Components/OrderStepper\"\n\nimport { createFragmentContainer, graphql, RelayProp } from \"react-relay\"\n\nimport { AcceptOfferMutation } from \"__generated__/AcceptOfferMutation.graphql\"\nimport { ConditionsOfSaleDisclaimer } from \"Apps/Order/Components/ConditionsOfSaleDisclaimer\"\nimport { ShippingSummaryItemFragmentContainer as ShippingSummaryItem } from \"Apps/Order/Components/ShippingSummaryItem\"\nimport { TransactionDetailsSummaryItemFragmentContainer as TransactionDetailsSummaryItem } from \"Apps/Order/Components/TransactionDetailsSummaryItem\"\nimport { Dialog, injectDialog } from \"Apps/Order/Dialogs\"\nimport {\n  CommitMutation,\n  injectCommitMutation,\n} from \"Apps/Order/Utils/commitMutation\"\nimport { trackPageViewWrapper } from \"Apps/Order/Utils/trackPageViewWrapper\"\nimport { CountdownTimer } from \"Components/v2/CountdownTimer\"\nimport { get } from \"Utils/get\"\nimport createLogger from \"Utils/logger\"\nimport { ArtworkSummaryItemFragmentContainer as ArtworkSummaryItem } from \"../../Components/ArtworkSummaryItem\"\nimport { CreditCardSummaryItemFragmentContainer as CreditCardSummaryItem } from \"../../Components/CreditCardSummaryItem\"\n\ninterface AcceptProps {\n  order: Accept_order\n  relay?: RelayProp\n  router: Router\n  route: RouteConfig\n  dialog: Dialog\n  commitMutation: CommitMutation\n  isCommittingMutation: boolean\n}\n\nconst logger = createLogger(\"Order/Routes/Offer/index.tsx\")\n\n@track()\nexport class Accept extends Component<AcceptProps> {\n  acceptOffer() {\n    return this.props.commitMutation<AcceptOfferMutation>({\n      variables: {\n        input: { offerId: this.props.order.lastOffer.id },\n      },\n      mutation: graphql`\n        mutation AcceptOfferMutation($input: CommerceBuyerAcceptOfferInput!) {\n          commerceBuyerAcceptOffer(input: $input) {\n            orderOrError {\n              ... on CommerceOrderWithMutationSuccess {\n                __typename\n                order {\n                  id\n                  ... on CommerceOfferOrder {\n                    awaitingResponseFrom\n                  }\n                }\n              }\n              ... on CommerceOrderWithMutationFailure {\n                error {\n                  type\n                  code\n                  data\n                }\n              }\n            }\n          }\n        }\n      `,\n    })\n  }\n\n  onSubmit = async () => {\n    try {\n      const orderOrError = (await this.acceptOffer()).commerceBuyerAcceptOffer\n        .orderOrError\n\n      if (orderOrError.error) {\n        this.handleAcceptError(orderOrError.error)\n        return\n      }\n\n      this.props.router.push(`/orders/${this.props.order.id}/status`)\n    } catch (error) {\n      logger.error(error)\n      this.props.dialog.showErrorDialog()\n    }\n  }\n\n  async handleAcceptError(error: { code: string; data: string }) {\n    logger.error(error)\n    switch (error.code) {\n      case \"capture_failed\": {\n        const parsedData = get(error, e => JSON.parse(e.data), {})\n\n        // https://stripe.com/docs/declines/codes\n        if (parsedData.decline_code === \"insufficient_funds\") {\n          this.showCardFailureDialog({\n            title: \"Insufficient funds\",\n            message:\n              \"There aren’t enough funds available on the card you provided. Please use a new card. Alternatively, contact your card provider, then press “Submit” again.\",\n          })\n        } else {\n          this.showCardFailureDialog({\n            title: \"Charge failed\",\n            message:\n              \"Payment authorization has been declined. Please contact your card provider, then press “Submit” again. Alternatively, use a new card.\",\n          })\n        }\n        break\n      }\n      case \"insufficient_inventory\": {\n        await this.props.dialog.showErrorDialog({\n          title: \"Not available\",\n          message: \"Sorry, the work is no longer available.\",\n        })\n        this.routeToArtistPage()\n        break\n      }\n      default:\n        this.props.dialog.showErrorDialog()\n    }\n  }\n\n  async showCardFailureDialog(props: { title: string; message: string }) {\n    const { confirmed } = await this.props.dialog.showConfirmDialog({\n      ...props,\n      cancelButtonText: \"OK\",\n      confirmButtonText: \"Use new card\",\n    })\n    if (confirmed) {\n      this.props.router.push(`/orders/${this.props.order.id}/payment/new`)\n    }\n  }\n\n  onChangeResponse = () => {\n    const { order } = this.props\n    this.props.router.push(`/orders/${order.id}/respond`)\n  }\n\n  artistId() {\n    return get(\n      this.props.order,\n      o => o.lineItems.edges[0].node.artwork.artists[0].id\n    )\n  }\n\n  routeToArtistPage() {\n    const artistId = this.artistId()\n\n    // Don't confirm whether or not you want to leave the page\n    this.props.route.onTransition = () => null\n    window.location.assign(`/artist/${artistId}`)\n  }\n\n  render() {\n    const { order, isCommittingMutation } = this.props\n\n    return (\n      <>\n        <HorizontalPadding px={[0, 4]}>\n          <Row>\n            <Col>\n              <OrderStepper\n                currentStep=\"Review\"\n                steps={counterofferFlowSteps}\n              />\n            </Col>\n          </Row>\n        </HorizontalPadding>\n        <HorizontalPadding>\n          <TwoColumnLayout\n            Content={\n              <Flex\n                flexDirection=\"column\"\n                style={isCommittingMutation ? { pointerEvents: \"none\" } : {}}\n              >\n                <Media at=\"xs\">\n                  <Flex flexDirection=\"column\">\n                    <ArtworkSummaryItem order={order} />\n                  </Flex>\n                  <Spacer mb={2} />\n                </Media>\n                <Flex flexDirection=\"column\">\n                  <CountdownTimer\n                    action=\"Respond\"\n                    note=\"Expired offers end the negotiation process permanently.\"\n                    countdownStart={order.lastOffer.createdAt}\n                    countdownEnd={order.stateExpiresAt}\n                  />\n                  <TransactionDetailsSummaryItem\n                    order={order}\n                    title=\"Accept seller's offer\"\n                    useLastSubmittedOffer={true}\n                    onChange={this.onChangeResponse}\n                  />\n                </Flex>\n                <Spacer mb={[2, 3]} />\n                <Media greaterThan=\"xs\">\n                  <Button\n                    onClick={this.onSubmit}\n                    loading={isCommittingMutation}\n                    size=\"large\"\n                    width=\"100%\"\n                  >\n                    Submit\n                  </Button>\n                  <Spacer mb={2} />\n                  <ConditionsOfSaleDisclaimer textAlign=\"center\" />\n                </Media>\n              </Flex>\n            }\n            Sidebar={\n              <Flex flexDirection=\"column\">\n                <Flex flexDirection=\"column\">\n                  <Media greaterThan=\"xs\">\n                    {className => (\n                      <ArtworkSummaryItem className={className} order={order} />\n                    )}\n                  </Media>\n                  <ShippingSummaryItem order={order} locked />\n                  <CreditCardSummaryItem order={order} locked />\n                </Flex>\n                <Media greaterThan=\"xs\">\n                  <Spacer mb={2} />\n                </Media>\n                <Media at=\"xs\">\n                  <>\n                    <Spacer mb={2} />\n                    <Button\n                      onClick={this.onSubmit}\n                      loading={isCommittingMutation}\n                      size=\"large\"\n                      width=\"100%\"\n                    >\n                      Submit\n                    </Button>\n                    <Spacer mb={2} />\n                    <ConditionsOfSaleDisclaimer />\n                  </>\n                </Media>\n              </Flex>\n            }\n          />\n        </HorizontalPadding>\n      </>\n    )\n  }\n}\n\nexport const AcceptFragmentContainer = createFragmentContainer(\n  injectCommitMutation(injectDialog(trackPageViewWrapper(Accept))),\n  {\n    order: graphql`\n      fragment Accept_order on CommerceOrder {\n        id\n        stateExpiresAt\n        lineItems {\n          edges {\n            node {\n              artwork {\n                id\n                artists {\n                  id\n                }\n              }\n            }\n          }\n        }\n        ... on CommerceOfferOrder {\n          lastOffer {\n            id\n            createdAt\n          }\n        }\n        ...TransactionDetailsSummaryItem_order\n        ...ArtworkSummaryItem_order\n        ...ShippingSummaryItem_order\n        ...CreditCardSummaryItem_order\n      }\n    `,\n  }\n)\n"],"file":"index.js"}