{"version":3,"sources":["../../../src/Apps/Order/redirects.tsx"],"names":["LEAVE_MESSAGING","confirmRouteExit","newLocation","oldLocation","router","pathname","match","matcher","matchedRoutes","getRoutes","Component","OrderApp","undefined","goToStatusIf","pred","reason","order","path","id","goToArtworkIfOrderWasAbandoned","state","artworkID","o","lineItems","edges","node","artwork","goToStatusIfOrderIsNotPending","goToShippingIfShippingIsNotCompleted","requestedFulfillment","goToPaymentIfPaymentIsNotCompleted","creditCard","goToShippingIfOrderIsNotOfferOrder","mode","goToOfferIfNoOfferMade","myLastOffer","goToStatusIfNotOfferOrder","goToStatusIfNotAwaitingBuyerResponse","awaitingResponseFrom","goToStatusIfOrderIsNotSubmitted","goToStatusIfNotLastTransactionFailed","lastTransactionFailed","goToReviewIfOrderIsPending","goToRespondIfMyLastOfferIsNotMostRecentOffer","lastOffer","DateTime","fromISO","createdAt","goToRespondIfAwaitingBuyerResponse","redirects","rules","children"],"mappings":"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","sourcesContent":["import { Location, RouteConfig, Router } from \"found\"\nimport { DateTime } from \"luxon\"\nimport { graphql } from \"react-relay\"\nimport { get } from \"Utils/get\"\nimport { RedirectPredicate, RedirectRecord } from \"./getRedirect\"\nimport { OrderApp } from \"./OrderApp\"\n\nimport { redirects_order } from \"__generated__/redirects_order.graphql\"\n\nconst LEAVE_MESSAGING =\n  \"Are you sure you want to refresh? Your changes will not be saved.\"\n\ninterface OrderQuery {\n  order: redirects_order\n}\n\ntype OrderPredicate = RedirectPredicate<OrderQuery>\n\nexport const confirmRouteExit = (\n  newLocation: Location,\n  oldLocation: Location,\n  router: Router\n) => {\n  // Refresh -- On refresh newLocation is null\n  if (!newLocation || newLocation.pathname === oldLocation.pathname) {\n    // Most browsers will ignore this and supply their own messaging for refresh\n    return LEAVE_MESSAGING\n  }\n\n  // Attempting to navigate to another route in the orders app\n  const match = router.matcher.match(newLocation)\n  if (match) {\n    // FIXME: Need to update found types: https://github.com/4Catalyzer/found/blob/master/src/Matcher.js#L27\n    // @ts-ignore\n    const matchedRoutes: RouteConfig[] | null = router.matcher.getRoutes(match)\n    if (matchedRoutes && matchedRoutes[0].Component === OrderApp) {\n      return undefined\n    }\n  }\n\n  return LEAVE_MESSAGING\n}\n\nconst goToStatusIf = (\n  pred: (order: redirects_order) => boolean,\n  reason\n): OrderPredicate => ({ order }) => {\n  if (pred(order)) {\n    return {\n      path: `/orders/${order.id}/status`,\n      reason,\n    }\n  }\n}\n\nconst goToArtworkIfOrderWasAbandoned: OrderPredicate = ({ order }) => {\n  if (order.state === \"ABANDONED\") {\n    const artworkID = get(order, o => o.lineItems.edges[0].node.artwork.id)\n    // If an artwork ID can't be found, redirect back to home page.\n    return {\n      path: artworkID ? `/artwork/${artworkID}` : \"/\",\n      reason: \"Order was abandoned\",\n    }\n  }\n}\n\nconst goToStatusIfOrderIsNotPending = goToStatusIf(\n  order => order.state !== \"PENDING\",\n  \"Order is no longer pending\"\n)\n\nconst goToShippingIfShippingIsNotCompleted: OrderPredicate = ({ order }) => {\n  if (!order.requestedFulfillment) {\n    return {\n      path: `/orders/${order.id}/shipping`,\n      reason: \"Shipping was not yet completed\",\n    }\n  }\n}\n\nconst goToPaymentIfPaymentIsNotCompleted: OrderPredicate = ({ order }) => {\n  if (!order.creditCard) {\n    return {\n      path: `/orders/${order.id}/payment`,\n      reason: \"Payment was not yet completed\",\n    }\n  }\n}\n\nconst goToShippingIfOrderIsNotOfferOrder: OrderPredicate = ({ order }) => {\n  if (order.mode !== \"OFFER\") {\n    return {\n      path: `/orders/${order.id}/shipping`,\n      reason: \"Order is not an offer order\",\n    }\n  }\n}\n\nconst goToOfferIfNoOfferMade: OrderPredicate = ({ order }) => {\n  if (order.mode === \"OFFER\" && !order.myLastOffer) {\n    return {\n      path: `/orders/${order.id}/offer`,\n      reason: \"No offer has been made yet\",\n    }\n  }\n}\n\nconst goToStatusIfNotOfferOrder = goToStatusIf(\n  order => order.mode !== \"OFFER\",\n  \"Not an offer order\"\n)\n\nconst goToStatusIfNotAwaitingBuyerResponse = goToStatusIf(\n  order => order.awaitingResponseFrom !== \"BUYER\",\n  \"Not currently awaiting buyer response\"\n)\n\nconst goToStatusIfOrderIsNotSubmitted = goToStatusIf(\n  order => order.state !== \"SUBMITTED\",\n  \"Order was not yet submitted\"\n)\n\nconst goToStatusIfNotLastTransactionFailed = goToStatusIf(\n  order => !order.lastTransactionFailed,\n  \"Order's lastTransactionFailed must be true\"\n)\n\nconst goToReviewIfOrderIsPending: OrderPredicate = ({ order }) => {\n  if (order.state === \"PENDING\") {\n    return {\n      path: `/orders/${order.id}/review`,\n      reason: \"Order is still pending\",\n    }\n  }\n}\n\nconst goToRespondIfMyLastOfferIsNotMostRecentOffer: OrderPredicate = ({\n  order,\n}) => {\n  if (\n    order.myLastOffer &&\n    order.lastOffer &&\n    DateTime.fromISO(order.myLastOffer.createdAt) >\n      DateTime.fromISO(order.lastOffer.createdAt)\n  ) {\n    return\n  }\n  return {\n    path: `/orders/${order.id}/respond`,\n    reason: \"myLastOffer is not most recent offer\",\n  }\n}\n\nconst goToRespondIfAwaitingBuyerResponse: OrderPredicate = ({ order }) => {\n  if (order.awaitingResponseFrom === \"BUYER\") {\n    return {\n      path: `/orders/${order.id}/respond`,\n      reason: \"Still awaiting buyer response\",\n    }\n  }\n}\n\nexport const redirects: RedirectRecord<OrderQuery> = {\n  path: \"\",\n  rules: [goToArtworkIfOrderWasAbandoned],\n  children: [\n    {\n      path: \"respond\",\n      rules: [\n        goToStatusIfNotOfferOrder,\n        goToStatusIfNotAwaitingBuyerResponse,\n        goToStatusIfOrderIsNotSubmitted,\n      ],\n    },\n    {\n      path: \"offer\",\n      rules: [\n        goToStatusIfOrderIsNotPending,\n        goToShippingIfOrderIsNotOfferOrder,\n      ],\n    },\n    {\n      path: \"shipping\",\n      rules: [goToStatusIfOrderIsNotPending, goToOfferIfNoOfferMade],\n    },\n    {\n      path: \"payment\",\n      rules: [\n        goToStatusIfOrderIsNotPending,\n        goToShippingIfShippingIsNotCompleted,\n      ],\n    },\n    {\n      path: \"payment/new\",\n      rules: [\n        goToStatusIfNotOfferOrder,\n        goToStatusIfOrderIsNotSubmitted,\n        goToStatusIfNotLastTransactionFailed,\n      ],\n    },\n    {\n      path: \"review\",\n      rules: [\n        goToStatusIfOrderIsNotPending,\n        goToShippingIfShippingIsNotCompleted,\n        goToPaymentIfPaymentIsNotCompleted,\n      ],\n    },\n    {\n      path: \"review/counter\",\n      rules: [\n        goToStatusIfNotOfferOrder,\n        goToStatusIfNotAwaitingBuyerResponse,\n        goToStatusIfOrderIsNotSubmitted,\n        goToRespondIfMyLastOfferIsNotMostRecentOffer,\n      ],\n    },\n    {\n      path: \"review/accept\",\n      rules: [\n        goToStatusIfNotOfferOrder,\n        goToStatusIfNotAwaitingBuyerResponse,\n        goToStatusIfOrderIsNotSubmitted,\n      ],\n    },\n    {\n      path: \"review/decline\",\n      rules: [\n        goToStatusIfNotOfferOrder,\n        goToStatusIfNotAwaitingBuyerResponse,\n        goToStatusIfOrderIsNotSubmitted,\n      ],\n    },\n    {\n      path: \"status\",\n      rules: [\n        goToReviewIfOrderIsPending,\n        goToShippingIfShippingIsNotCompleted,\n        goToPaymentIfPaymentIsNotCompleted,\n        goToRespondIfAwaitingBuyerResponse,\n      ],\n    },\n  ],\n}\n\ngraphql`\n  fragment redirects_order on CommerceOrder {\n    id\n    mode\n    state\n    lastTransactionFailed\n    ... on CommerceOfferOrder {\n      myLastOffer {\n        id\n        createdAt\n      }\n      lastOffer {\n        id\n        createdAt\n      }\n      awaitingResponseFrom\n    }\n    requestedFulfillment {\n      __typename\n    }\n    lineItems {\n      edges {\n        node {\n          artwork {\n            id\n          }\n        }\n      }\n    }\n    creditCard {\n      id\n    }\n  }\n`\n"],"file":"redirects.js"}